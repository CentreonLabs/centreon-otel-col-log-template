# Copyright 2025-Present Centreon.
# SPDX-License-Identifier: 	AGPL-3.0-or-later

receivers:
  filelog/postgres-base:
    include:
      - /var/log/postgresql/postgresql-*.log
    include_file_path: true
    multiline:
      line_start_pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+ '
    preserve_trailing_whitespaces: true
    preserve_leading_whitespaces: false
    operators:
      - type: regex_parser
        regex: '^(?P<ts>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+)\s+\[(?P<pid>\d+)\]\s+(?P<level>[A-Z]+):\s+(?P<body>(.|\n)*)'
        timestamp:
          parse_from: attributes.ts
          layout: "%Y-%m-%d %H:%M:%S.%f %Z"
        severity:
          parse_from: attributes.level
          mapping:
            debug:
              - debug1
              - debug2
              - debug3
              - debug4
              - debug5
            info:
              - info
              - notice
              - log
            warn:
              - warning
            error:
              - error
            fatal:
              - fatal
              - panic
      - type: move
        from: attributes["body"]
        to: body
      # The postgres process
      - type: move
        from: attributes["pid"]
        to: attributes["process.pid"]
      # Add a service version, the template version
      - type: add
        field: resource["service.version"]
        value: "1.0.0"
      # Add the service name
      - type: add
        field: resource["service.name"]
        value: "postgres"
      - type: remove
        field: attributes["ts"]
      - type: remove
        field: attributes["level"]

service:
  pipelines:
    logs:
      receivers: [filelog/postgres-base]
      processors: [batch, resourcedetection]
      exporters: [otlphttp/centreon]
